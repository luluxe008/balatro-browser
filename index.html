<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Balatro on the Web</title>
    <link rel="stylesheet" href="style.css" />
    <link href="https://pound-os.neocities.org/balatro.css" rel="stylesheet">
    <script src="lib/data.js"></script>
    <script src="lib/FileSaver.min.js"></script>
    <script src="lib/jszip.min.js"></script>
    <script src="lib/toml.js"></script>
    <!--
    <script src="renderVersionList.js"></script>
    <script src="mods.js"></script>
    <script src="cache.js"></script>
    -->
    <script src="patches.js"></script>
    <script src="runVersion.js"></script>

    <!--<script src="loadVersion.js"></script>-->
    <script src="build.js"></script>
    <script src="app.js"></script>
  </head>
  <body style="display: flex;" class="center">
    <div class="container" >


        <div class="outer-desc" id="autoload">
          <h1 class="joker-title">Load the game</h1>
          <div class="inner-desc">
            <span>Click here to <chips>load</chips> the game.<br/><gray id="autoload-info">(currently unloaded)</gray></span>
          </div>
        </div>



        
 

        <div style="display: flex;" class="center">
          <button id="myBtn">PLAY</button>
        </div>


        <div class="outer-desc" id="manual-load">
          <h1 class="joker-title">Manual Load</h1>

          <div class="inner-desc">
            <label for="exeInput" id="input-label">Click here to <chips>manually</chips> load the execuatable (an .exe or .zip)<br/>
              <gray id="file-name">(no file loaded)</gray>
              <br/><mult>WARNING: </mult>On IOS this doesn't seem to work</label>
              <input name="exeInput" type="file" id="exeInput" accept=".zip,.exe">
          </div>
        </div>

        <div class="outer-desc" id="download">
            <h1 class="center joker-title">Download</h1>
            <div class="inner-desc">
                <span>Click here to download the game.<br><gray>(This will download your <mult>own copy</mult> of Balatro)</gray></span>
            </div>
        </div>
        
    </div>
      <script>
        const autoload = document.getElementById("autoload")

        const input = document.getElementById("exeInput")
        const file_name = document.getElementById("file-name")
        const autoload_info = document.getElementById("autoload-info")
        
        let prefer = "none"

        let game_blob;


        if (input.files.length > 0){
          file_name.textContent = "(" + input.files[0].name + " is loaded)"
          prefer = "file"
        }


        input.onchange = (event) => {
          file_name.textContent = "(" +input.files[0].name + " is loaded)"
          prefer = "file"
        }

        autoload.onclick = fetch_game

        document.getElementById("myBtn").onclick = () =>{
          play()
        }

        document.getElementById("download").onclick = () => {
          let a = document.createElement("a")
          a.href = "game/Balatro.exe"
          a.download = "Balatro.exe"
          a.click()
        }

        document.getElementById("manual-load").onclick = () => {
          input.click()
        }


        async function play(){
          const file_input = document.getElementById("exeInput")

         
          if (prefer == "file"){
            console.log("There is a file, loading it from file...");
            let game = await buildFromSource(file_input.files[0], {});
            await play_game_from_blob(game)
          }
          else if (prefer == "download"){
            console.log("there is a game blob, loading it from blob")
            let game = await buildFromSource(game_blob, {});
            await play_game_from_blob(game)
          }
          else{
            alert("You didn't load the balatro version")
          }
          
        }


        async function fetch_game(){
          var res = await fetch("game/Balatro.exe")
          var reader = res.body.getReader()
          const contentLength = res.headers.get('content-length');
          const total = parseInt(contentLength, 10);
          var values = []
          var loaded = 0

          while (true){
            var {done, value} = await reader.read()
            if (done) break;
            loaded += value.byteLength
            values.push(value)
            autoload_info.innerText = "(" + ((loaded/total)*100).toFixed(1) + "% loaded)"
          }

          var blob = new Blob(values)
          game_blob = blob

          autoload_info.innerText = "(fully loaded)"

          prefer = "download"
        }
        
      </script>
    </div>
  </body>
</html>
